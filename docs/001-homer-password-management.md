---
**Created:** 2025-12-09  
**Last Updated:** 2025-12-09  
**Generated by:** AI Assistant
---

# Homer Password Management

## Overview

Homer ships with a hardcoded default password (`admin/sipcapture`). VoiceGateway automatically replaces this with a secure random password stored in Kubernetes secrets.

## Components

### 1. Homer Password Secret (`vg-homer-password`)

**Location:** `templates/common-secrets/vg-homer-password.yaml`

**Creation:**
- Created **once** during initial installation via `pre-install` hook
- Generates a random 32-character password
- **Never recreated** on upgrades (protected by `helm.sh/resource-policy: keep`)

**Lifecycle:**
```yaml
"helm.sh/hook": "pre-install,pre-upgrade"
"helm.sh/resource-policy": "keep"
```

**Key Logic:**
```yaml
{{- if and (.Values.homer.enabled) (not (lookup "v1" "Secret" $.Release.Namespace "vg-homer-password")) }}
```
Only creates if secret doesn't already exist.

---

### 2. Homer Password Update Job

**Location:** `templates/homer/job.yaml`

**Purpose:** Changes Homer's default password to match the value stored in `vg-homer-password` secret.

**Execution Flow:**

1. **Init Container** - Waits for Homer API to be ready
   - Polls `/api/v3/auth` endpoint
   - Max 60 attempts (5 minutes timeout)

2. **Main Container** - Updates password
   - Logs in with default credentials (`admin/sipcapture`)
   - Retrieves auth token and admin UUID
   - Updates admin password via PUT `/api/v3/users/{uuid}`
   - New password sourced from `vg-homer-password` secret

**When It Runs:**
- `post-install` - First deployment
- `pre-upgrade` - Every release/upgrade

**Configuration:**
```yaml
homer:
  hookEnabled: true
  hook: "post-install,pre-upgrade"
  hookDeletePolicy: "before-hook-creation,hook-succeeded,hook-failed"
```

**Job Lifecycle:**
- Runs as Kubernetes Job
- Auto-deletes after 1 day (`ttlSecondsAfterFinished: 86400`)
- Backoff limit: 5 retries

---

## Behavior Summary

| Event | Secret Created? | Update Job Runs? |
|-------|----------------|------------------|
| **First Install** | ✅ Yes | ✅ Yes (`post-install`) |
| **Upgrade/Release** | ❌ No (already exists) | ✅ Yes (`pre-upgrade`) |
| **Secret Deleted Manually** | ✅ Yes (on next upgrade) | ❌ No (waits for secret) |

---

## Why Both Components?

1. **Secret Persistence:** Password survives upgrades and pod restarts
2. **Job Re-sync:** Ensures Homer's internal password matches the secret (even if manually changed)
3. **Security:** Replaces publicly known default credentials

---

## Troubleshooting

### Job Fails with "Failed to get auth token"

**Possible causes:**
- Homer not ready yet (init container should prevent this)
- Default credentials already changed manually
- Homer API unreachable

**Solution:** Check Homer pod logs and ensure it's running.

### Password Unknown

The password is stored in the `vg-homer-password` secret:

```bash
kubectl get secret vg-homer-password -n <namespace> -o jsonpath='{.data.homer-password}' | base64 -d
```

### Force Password Reset

1. Delete the secret: `kubectl delete secret vg-homer-password -n <namespace>`
2. Run `helm upgrade` - Secret recreates with new random password
3. Update job runs automatically to sync Homer

---

## Configuration Options

Disable the update job:
```yaml
homer:
  hookEnabled: false
```

Change hook timing:
```yaml
homer:
  hook: "post-install"  # Only run on first install
```

Disable Homer entirely:
```yaml
homer:
  enabled: false
```

