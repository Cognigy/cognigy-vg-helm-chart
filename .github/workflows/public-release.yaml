# ===========================================================================
# Helm Chart Release Pipeline
# ===========================================================================
#
# This workflow runs when a final release tag is created (e.g. v2025.26.0).
# It does NOT run for preview tags (e.g. v2025.26.0-1.20260119170743).
# Preview tags are filtered out at job level by checking for '-' in the tag name.
#
# What it does:
# 1. Publishes the Helm chart to OCI registry (Azure Container Registry)
# 2. Syncs the chart to cognigy-vg-helm-chart repo and creates a release tag
#
# Testing: Use workflow_dispatch with dry_run=true (default) to validate
# without pushing to OCI or cognigy-vg-helm-chart. Set dry_run=false for real run.
#
# ===========================================================================
# REQUIRED SECRETS:
# - PROD_ACR_URL: Azure Container Registry URL (e.g. myregistry.azurecr.io)
# - PROD_REGISTRY_USERNAME: ACR username
# - PROD_REGISTRY_PASSWORD: ACR password
# - VG_RELEASE_APP_ID: GitHub App ID (same as preview-release)
# - VG_RELEASE_APP_PRIVATE_KEY: GitHub App private key
# ===========================================================================

name: Public Helm Chart Release

on:
  push:
    tags:
      # Match version tags (final + preview) - we filter out preview tags at job level
      - "v[0-9][0-9][0-9][0-9].[0-9]*.[0-9]*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry Run - Skip OCI push and GitHub sync, only validate and log"
        type: boolean
        default: true

permissions:
  contents: read

env:
  CHART_NAME: voicegateway

jobs:
  # ===========================================================================
  # JOB 1: Publish Helm Chart to OCI Registry
  # ===========================================================================
  publish_oci:
    name: Publish Helm Chart to OCI
    runs-on: ubuntu-latest
    # Skip preview tags (contain '-') - only run for final releases like v2026.3.0
    if: ${{ github.event_name == 'workflow_dispatch' || !contains(github.ref_name, '-') }}
    outputs:
      dry_run: ${{ steps.set-dry-run.outputs.dry_run }}
    steps:
      - name: Set dry run flag
        id: set-dry-run
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          echo "dry_run=${DRY_RUN:-false}" >> $GITHUB_OUTPUT
          if [[ "${DRY_RUN}" == "true" ]]; then
            echo "::notice::DRY RUN mode - will skip OCI push and GitHub sync"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.8.2"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Login to OCI Registry
        if: steps.set-dry-run.outputs.dry_run != 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.PROD_ACR_URL }}
          username: ${{ secrets.PROD_REGISTRY_USERNAME }}
          password: ${{ secrets.PROD_REGISTRY_PASSWORD }}

      - name: Package Helm chart
        run: |
          helm version
          helmChartVersion="$(yq e '.version' Chart.yaml)"
          echo "Helm Chart ${{ env.CHART_NAME }} version: $helmChartVersion"
          helm package --dependency-update .
          ls -la ./*.tgz

      - name: Push to OCI Registry
        if: steps.set-dry-run.outputs.dry_run != 'true'
        run: |
          helmChartVersion="$(yq e '.version' Chart.yaml)"
          helm push ./${{ env.CHART_NAME }}-$helmChartVersion.tgz oci://${{ secrets.PROD_ACR_URL }}/helm

      - name: "[Dry Run] Would push to OCI"
        if: steps.set-dry-run.outputs.dry_run == 'true'
        run: |
          helmChartVersion="$(yq e '.version' Chart.yaml)"
          echo "Would run: helm push ./${{ env.CHART_NAME }}-$helmChartVersion.tgz oci://\$PROD_ACR_URL/helm"

  # ===========================================================================
  # JOB 2: Sync to cognigy-vg-helm-chart and create release tag
  # ===========================================================================
  sync_github_repo:
    name: Sync to cognigy-vg-helm-chart
    runs-on: ubuntu-latest
    needs: publish_oci
    # Skip preview tags (contain '-') - only run for final releases like v2026.3.0
    if: ${{ github.event_name == 'workflow_dispatch' || !contains(github.ref_name, '-') }}
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App token for branch protection bypass
        id: app-token
        if: steps.draft-check.outputs.skip != 'true'
        uses: actions/create-github-app-token@v2
        with:
            app-id: ${{ secrets.BYPASS_BRANCH_PROTECTION_APP_ID }}
            private-key: ${{ secrets.BYPASS_BRANCH_PROTECTION_PRIVATE_KEY }}
            owner: Cognigy
            repositories: cognigy-vg-helm-chart

      - name: Checkout source repo (vg-helm-chart)
        uses: actions/checkout@v4
        with:
          path: vg-helm-chart

      - name: Checkout target repo (cognigy-vg-helm-chart)
        uses: actions/checkout@v4
        with:
          repository: Cognigy/cognigy-vg-helm-chart
          token: ${{ steps.app-token.outputs.token }}
          path: cognigy-vg-helm-chart
          persist-credentials: true

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.8.2"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Sync chart and create release
        env:
          GITHUB_USER: "Voice Gateway CI"
          GITHUB_EMAIL: "voice-gateway-ci@cognigy.com"
          DRY_RUN: ${{ needs.publish_oci.outputs.dry_run }}
        run: |
          set -euo pipefail

          helmChartVersion="$(yq e '.version' vg-helm-chart/Chart.yaml)"
          echo "Helm Chart version: $helmChartVersion"

          # Clear target repo (preserve .git) and copy chart contents
          cd cognigy-vg-helm-chart
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..

          rsync -av --exclude='.git' --exclude='CHANGELOG*' vg-helm-chart/ cognigy-vg-helm-chart/

          cd cognigy-vg-helm-chart

          git config user.name "$GITHUB_USER"
          git config user.email "$GITHUB_EMAIL"

          git add -A
          git status

          if [[ "$DRY_RUN" == "true" ]]; then
            echo "::notice::[DRY RUN] Would commit and push to cognigy-vg-helm-chart"
            echo "::notice::[DRY RUN] Would create and push tag v$helmChartVersion"
            exit 0
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit - chart may already be up to date"
          else
            git commit -m "Adding files for Helm Chart $helmChartVersion"
            git push origin main
          fi

          # Create and push tag (idempotent - skip if exists)
          if git rev-parse "v$helmChartVersion" >/dev/null 2>&1; then
            echo "Tag v$helmChartVersion already exists"
          else
            git tag "v$helmChartVersion"
            git push origin "v$helmChartVersion"
          fi
